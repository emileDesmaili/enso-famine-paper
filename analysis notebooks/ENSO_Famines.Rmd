---
title: "R Notebook"
output: html_notebook
editor_options:
 chunk_output_type: inline
---


```{r}
suppressPackageStartupMessages(suppressWarnings(library(ggh4x)))
suppressPackageStartupMessages(suppressWarnings(library(dplyr)))
suppressPackageStartupMessages(suppressWarnings(library(tidyr)))
suppressPackageStartupMessages(suppressWarnings(library(tidyverse)))
suppressPackageStartupMessages(suppressWarnings(library(ggplot2)))
suppressPackageStartupMessages(suppressWarnings(library(magrittr)))
suppressPackageStartupMessages(suppressWarnings(library(lme4)))
suppressPackageStartupMessages(suppressWarnings(library(plm)))
suppressPackageStartupMessages(suppressWarnings(library(lmtest)))
suppressPackageStartupMessages(suppressWarnings(library(car)))
suppressPackageStartupMessages(suppressWarnings(library(lmerTest)))
suppressPackageStartupMessages(suppressWarnings(library(nlme)))
suppressPackageStartupMessages(suppressWarnings(library(pracma)))
suppressPackageStartupMessages(suppressWarnings(library(sjPlot)))
suppressPackageStartupMessages(suppressWarnings(library(corrplot)))
suppressPackageStartupMessages(suppressWarnings(library(parameters)))
suppressPackageStartupMessages(suppressWarnings(library(see)))
suppressPackageStartupMessages(suppressWarnings(library(caret)))
suppressPackageStartupMessages(suppressWarnings(library(remotes)))
suppressPackageStartupMessages(suppressWarnings(library(performance)))
suppressPackageStartupMessages(suppressWarnings(library(easystats)))
suppressPackageStartupMessages(suppressWarnings(library(future)))
suppressPackageStartupMessages(suppressWarnings(library(stringr)))
suppressPackageStartupMessages(suppressWarnings(library(glue)))
suppressPackageStartupMessages(suppressWarnings(library(ggrepel)))     
suppressPackageStartupMessages(suppressWarnings(library(ggdist) ))     
suppressPackageStartupMessages(suppressWarnings(library(scales)))      
suppressPackageStartupMessages(suppressWarnings(library(patchwork)))
suppressPackageStartupMessages(suppressWarnings(library(maps)))
suppressPackageStartupMessages(suppressWarnings(library(sf)))
suppressPackageStartupMessages(suppressWarnings(library(gridExtra)))
suppressPackageStartupMessages(suppressWarnings(library(gam)))
suppressPackageStartupMessages(suppressWarnings(library(pscl)))
suppressPackageStartupMessages(suppressWarnings(library(lme4)))
suppressPackageStartupMessages(suppressWarnings(library(interactions)))
suppressPackageStartupMessages(suppressWarnings(library(forecast)))
suppressPackageStartupMessages(suppressWarnings(library(viridis)))
suppressPackageStartupMessages(suppressWarnings(library(mgcv)))
suppressPackageStartupMessages(suppressWarnings(library(mvgam)))
suppressPackageStartupMessages(suppressWarnings(library(fixest)))
suppressPackageStartupMessages(suppressWarnings(library(ivreg)))
suppressPackageStartupMessages(suppressWarnings(library(rms)))
suppressPackageStartupMessages(suppressWarnings(library(ggspatial)))
suppressPackageStartupMessages(suppressWarnings(library(ggpubr)))
suppressPackageStartupMessages(suppressWarnings(library(ltm)))
suppressPackageStartupMessages(suppressWarnings(library(lpirfs)))
suppressPackageStartupMessages(suppressWarnings(library(pglm)))
suppressPackageStartupMessages(suppressWarnings(library(data.table)))
suppressPackageStartupMessages(suppressWarnings(library(survival)))
suppressPackageStartupMessages(suppressWarnings(library(survminer)))
suppressPackageStartupMessages(suppressWarnings(library(coxme)))
suppressPackageStartupMessages(suppressWarnings(library(stargazer)))
suppressPackageStartupMessages(suppressWarnings(library(finalfit)))
suppressPackageStartupMessages(suppressWarnings(library(modelsummary)))
suppressPackageStartupMessages(suppressWarnings(library(ggtext)))

```

# Data
```{r}

data <- read.csv("../processed data/famine_region_data.csv") %>% mutate(Decade = floor(Year/10)*10) %>% 
  #sort years within region
  arrange(Region, Year) 

pdata = fixest::panel(data, panel = ~ Region+Year)


```


```{r}
# Step 1: filter to famine years only
famine_periods <- data %>%
  filter(Famine > 0) %>%
  group_by(Region) %>%
  mutate(group_id = rleid(Famine_dur2)) %>%  # assign unique ID to each block of same Famine_dur2
  ungroup()

# Step 2: summarize per famine episode
famine_summary <- famine_periods %>%
  group_by(Region, group_id) %>%
  arrange(Year,.by_group = TRUE) %>%  # Ensure values are in chronological order
  summarise(
    start_year = min(Year),
    duration = first(Famine_dur2),
    avg_PDSI = mean(PDSI, na.rm = TRUE),
    avg_PDSI_europe = mean(PDSI_europe, na.rm = TRUE),
    avg_temp_summer = mean(temp_summer, na.rm = TRUE),
    avg_temp_winter = mean(temp_winter, na.rm = TRUE),
    avg_precip_summer = mean(precip_summer, na.rm = TRUE),
    avg_precip_winter = mean(precip_winter, na.rm = TRUE),
    avg_temp_summer_europe = mean(temp_summer_europe, na.rm = TRUE),
    avg_temp_winter_europe = mean(temp_winter_europe, na.rm = TRUE),
    avg_precip_summer_europe = mean(precip_summer_europe, na.rm = TRUE),
    avg_precip_winter_europe = mean(precip_winter_europe, na.rm = TRUE),
    avg_ongoing_wars = mean(ongoing_wars, na.rm = TRUE),
    avg_Deaths = mean(Deaths, na.rm = TRUE),
    avg_Death_ratio = mean(Death_ratio, na.rm = TRUE),
    avg_JSL = mean(JSL, na.rm = TRUE),
    avg_NAO_cal = mean(NAO_cal, na.rm = TRUE),
    n_first = pmax(floor(duration / 2), 1),      
    max_nino_first_n = ifelse(n_first > 0,
                              max(head(nino34, n_first), na.rm = TRUE),
                              NA_real_),
    avg_nino_first_n = ifelse(n_first > 0,
                              mean(head(nino34, n_first), na.rm = TRUE),
                              NA_real_),
    avg_nino34 = mean(nino34, na.rm = TRUE),
    avg_2y_nino = mean(nino34[1:2], na.rm = TRUE),
    max_2y_nino = max(nino34[1:2], na.rm = TRUE),
    .groups = "drop"
  )
```



```{r}
datasummary(duration*Region ~ mean + sd + min + max + N, data = famine_summary,
            output = "../../figures/tables/summary_famine.tex",
            title = "Summary Statistics of Famine Episodes")
```



```{r}
#save to csv
famine_summary %>% write.csv('../processed data/famine_survival.csv')
```






```{r, fig.width=5, fig.height=5}

# Compute mean Niño3.4 per duration (for coloring)
bin_means <- famine_summary %>%
  group_by(duration) %>%
  summarise(mean_nino34 = median(avg_nino34, na.rm = TRUE), .groups = "drop")

# Color mapping proportional to mean Niño3.4
reds_pal <- scales::col_numeric("Reds", domain = range(bin_means$mean_nino34, na.rm = TRUE))
bin_colors <- setNames(reds_pal(bin_means$mean_nino34), bin_means$duration)

ggplot(famine_summary, aes(y = as.factor(duration), x = avg_nino34, fill = as.factor(duration))) +
  
  geom_boxplot(color = "black", linewidth = 1, alpha = 0.5) +
  geom_jitter(width = 0.15, size = 1.5, alpha = 0.7, color = "black") +
  
  scale_fill_manual(values = bin_colors) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 1) +
  labs(
    x = "Famine duration (years)",
    y = "NINO3.4 anomaly"
  ) +
  theme_classic(base_size = 15) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(size = 15, face = "plain"),
    axis.text.y = element_text(size = 15, face = "plain"),
    axis.title = element_text(size = 15, face = "plain")
  )

ggsave("../../figures/plots/famine_duration_boxplot.pdf", device = cairo_pdf)
```






# 1. Survival time varying

```{r}
data_table <- data %>% as.data.table()

# Assign famine IDs to contiguous famine periods
data_table[, famine_id := rleid(Famine) * Famine]
data_table <- data_table[Famine == 1]

# Long format for Cox time-varying survival
famine_long <- data_table %>%
  group_by(famine_id, Region) %>%
  arrange(Year) %>%
  mutate(
    start = row_number() - 1,
    stop = row_number(),
    event = if_else(stop == max(stop), 1, 0)
  ) %>%
  ungroup()
```


## Regression Tables




```{r}
cox_base <- coxph(Surv(start, stop, event) ~ nino34, data = famine_long)


cox_strata <- coxph(Surv(start, stop, event)  ~ nino34  + strata(Region), 
                   data = famine_long)

cox_cluster_strata <- coxph(Surv(start, stop, event) ~ nino34 + cluster(famine_id) + strata(Region), 
                   data = famine_long, robust = TRUE)

cox_controls <- coxph(Surv(start, stop, event) ~ nino34 + ongoing_wars + temp_winter + precip_winter + PDSI + temp_summer + log(1+Deaths), 
                      data = famine_long)

cox_controls_cluster <- coxph(Surv(start, stop, event) ~ nino34 + ongoing_wars + temp_winter + precip_winter +  PDSI + temp_summer + log(1+Deaths)  + cluster(famine_id), 
                                 data = famine_long, robust = TRUE)


cox_controls_strata <- coxph(Surv(start, stop, event) ~ nino34 + ongoing_wars + temp_winter + precip_winter +  PDSI + temp_summer + log(1+Deaths) +  strata(Region), data = famine_long)

# Interaction

cox_inter <- coxph(Surv(start, stop, event) ~ nino34:strata(Region) + Region, 
                   data = famine_long)


cox_inter_cluster <- coxph(Surv(start, stop, event) ~ nino34:strata(Region) + cluster(famine_id) + Region, 
                   data = famine_long, robust = TRUE)

cox_inter_controls <- coxph(Surv(start, stop, event) ~ nino34:strata(Region) + ongoing_wars + temp_winter + precip_winter +  PDSI + temp_summer + log(1+Deaths), 
                   data = famine_long)

cox_inter_strata <- coxph(Surv(start, stop, event) ~ nino34:strata(Region) + strata(Region), 
                   data = famine_long)

# RE

cox_frail <- coxph(Surv(start, stop, event) ~ nino34 + frailty(Region), 
                   data = famine_long)

cox_frail_strata <- coxph(Surv(start, stop, event) ~ nino34 + frailty(Region) + strata(Region), 
                   data = famine_long)

cox_ME <- coxme(Surv(start, stop, event) ~ nino34 + ongoing_wars+ (1+nino34|Region), 
                   data = famine_long)

summary(cox_strata)

#get the 95$ CI for watimate
confint(cox_strata)

```


```{r}
# --- Models list ---
models <- list(
  "(1)"                        = cox_base,
  "(2)"                 = cox_strata,
  "(3)"       = cox_cluster_strata,
  "(4)"               = cox_frail,
  "(5)"     = cox_controls_cluster,
  "(6)"      = cox_controls_strata
)

# Cluster variable
cluster_var <- famine_long$famine_id

# Robust SEs
robust_vcovs <- lapply(models, function(model) {
  if (!inherits(model, "coxph")) return(NULL)
  has_cluster <- any(grepl("cluster", deparse(model$call)))
  if (has_cluster) {
    tryCatch(sandwich::vcovCL(model, cluster = cluster_var), error = function(e) NULL)
  } else {
    NULL
  }
})

# Extract AIC, BIC, Concordance, PH test
extract_info <- function(model) {
  if (!inherits(model, "coxph")) return(list(AIC = NA, BIC = NA, Concordance = NA, PH_p = NA))
  
  aic <- AIC(model)
  bic <- BIC(model)
  
  # Concordance
  c_index <- tryCatch({
    summary(model)$concordance[1]
  }, error = function(e) NA)

  # PH test p-value for nino34
  ph_p <- NA
  if (!any(grepl("frailty", deparse(model$call)))) {
    test <- try(cox.zph(model), silent = TRUE)
    if (!inherits(test, "try-error") && "nino34" %in% rownames(test$table)) {
      ph_p <- round(test$table["nino34", "p"], 3)
    }
  }

  list(AIC = round(aic, 1), BIC = round(bic, 1), Concordance = round(c_index, 3), PH_p = ph_p)
}
info_list <- lapply(models, extract_info)
aic_values <- sapply(info_list, `[[`, "AIC")
bic_values <- sapply(info_list, `[[`, "BIC")
cindex_values <- sapply(info_list, `[[`, "Concordance")
ph_tests <- sapply(info_list, function(x) ifelse(is.na(x$PH_p), "-", sprintf("%.3f", x$PH_p)))

# Automatically detect model features
detect_in_call <- function(models, pattern) {
  sapply(models, function(model) {
    if (!inherits(model, "coxph")) return("-")
    ifelse(any(grepl(pattern, deparse(model$call))), "Yes", "No")
  })
}

region_FE <- detect_in_call(models, "strata\\(.*Region.*\\)|Region")
clustered_SEs <- detect_in_call(models, "cluster")
strata_region <- detect_in_call(models, "strata\\(.*Region.*\\)")
controls_included <- detect_in_call(models, "wars|pop")
frailty_included <- detect_in_call(models, "frailty")

extra_rows <- tibble::tibble(
  term = c(
    "Clustered SEs",
    "Strata by Region",
    "Controls",
    "Random Effects",
    "Proportional Hazards p",
    "Concordance Index",
    "AIC",
    "BIC"
  ),
  !!!setNames(
    purrr::transpose(list(
      as.character(clustered_SEs),
      as.character(strata_region),
      as.character(controls_included),
      as.character(frailty_included),
      as.character(ph_tests),
      sprintf("%.3f", cindex_values),
      sprintf("%.1f", aic_values),
      sprintf("%.1f", bic_values)
    )),
    names(models)
  )
)

# Generate summary table
modelsummary(
  title = '\\label{tab:dynsurvENSO}Log Hazard Ratio of Nino 3.4 on Famine Duration, Time-varying Cox Model',
  escape = FALSE,
  models,
  coef_omit = "^(?!.*nino34).*",
  vcov = robust_vcovs,
  gof_omit = ".*",
  add_rows = extra_rows,
  stars = c(`*` = 0.1, `**` = 0.05, `***` = 0.01),
  output = "../../figures/tables/dyn_survival_models_reg.tex"
)
```


## Coef plots

```{r, fig.width=6, fig.height=5}
models <- list(
  "Base"                        = cox_base,
  "Strata"                 = cox_strata,
  "Strata + Clustered S.E."       = cox_cluster_strata,
  "Frailty"               = cox_frail,
  "Controls + Clustered S.E"     = cox_controls_cluster,
  "Controls + Strata"      = cox_controls_strata
)

extract_nino34 <- function(model) {
  if (!inherits(model, "coxph")) return(NULL)
  
  # Extract the coefficients and check if robust SEs are available
  coefs <- summary(model)$coefficients
  nino34_coef <- coefs["nino34", "coef"]
  
  # Check if robust SE is available, otherwise use the regular SE
  if ("robust se" %in% colnames(coefs)) {
    nino34_se <- coefs["nino34", "robust se"]
  } else {
    nino34_se <- coefs["nino34", "se(coef)"]
  }
  
  return(c(coef = nino34_coef, se = nino34_se))
}

# Apply the function to all models and create a data frame
nino34_results <- lapply(models, extract_nino34)
nino34_df <- do.call(rbind, nino34_results)
nino34_df <- as.data.frame(nino34_df)
nino34_df$Model <- rownames(nino34_df)

# Calculate lower and upper bounds for the confidence interval
nino34_df$lower <- nino34_df$coef - 1.96 * nino34_df$se
nino34_df$upper <- nino34_df$coef + 1.96 * nino34_df$se

# Add a label column for y-axis, bold only for Strata
nino34_df$Model_label <- paste0("", nino34_df$Model, "")



ggplot(nino34_df, aes(x = reorder(Model, coef), y = coef, ymin = lower, ymax = upper)) +
  geom_pointrange(color='firebrick', size = 1.3, fatten = 2) +
  scale_color_identity() +
  theme_classic(base_size = 16) +
  labs(
    y = "NINO3.4 log hazard ratio", 
    x = "Survival Model"
  ) +
theme_classic(base_size = 14) +
  theme(
    text = element_text(color = "black", size = 14),   # all text black, size 12
    legend.position = "top",
    legend.text = element_text(color = "black", size = 14),
    legend.title = element_text(color = "black", size = 13),
    axis.text.x = element_text(angle = 25, hjust = 1, color = "black", size = 14),
    axis.text.y = element_text(color = "black", size = 14),
    axis.title.x = element_text(color = "black", size = 14),
    axis.title.y = element_text(color = "black", size = 14),
    axis.ticks.length = unit(0.25, "cm"),
    axis.line = element_line(size = 0.6, color = "black"),
    panel.border = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  ylim(-0.7, 0.1) +
  scale_x_discrete(labels = nino34_df$Model_label)

ggsave("../figures/plots/nino34_survival_coef_dynamic.pdf", device = cairo_pdf)
```

## Loo

```{r}
# --- Full model (baseline) ---
cox_strata <- coxph(Surv(start, stop, event) ~ nino34 + strata(Region),
                    data = famine_long)
full_coef <- tidy(cox_strata) %>% filter(term == "nino34")

# --- Leave-one-out by region ---
loo_region <- unique(famine_long$Region) %>%
  map_dfr(function(r) {
    m <- coxph(Surv(start, stop, event) ~ nino34 + strata(Region),
               data = famine_long %>% filter(Region != r))
    tidy(m) %>% filter(term == "nino34") %>%
      mutate(left_out = r)
  })

# --- Leave-one-out by famine event ---
loo_event <- unique(famine_long$famine_id) %>%
  map_dfr(function(fam_id) {
    m <- coxph(Surv(start, stop, event) ~ nino34 + strata(Region),
               data = famine_long %>% filter(famine_id != fam_id))
    tidy(m) %>% filter(term == "nino34") %>%
      mutate(left_out = fam_id)
  })

# --------------------
# PLOT 1: Leave-one-region-out
# --------------------
ggplot(loo_region, aes(x = reorder(left_out, estimate), y = estimate)) +
  geom_point(color = "steelblue", size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error,
                    ymax = estimate + 1.96*std.error),
                width = 0.2, color = "steelblue") +
  geom_hline(yintercept = full_coef$estimate, linetype = "dashed", color = "red") +
  coord_flip() +
  labs(y = "Log hazard ratio (nino34)",
       x = "Region removed")+
  theme_minimal(base_size = 13)


  

```

```{r, fig.width=6, fig.height=5}
ggplot(loo_event, 
                  aes(y = reorder(left_out, estimate), 
                      x = estimate,
                      xmin = estimate - 1.96*std.error,
                      xmax = estimate + 1.96*std.error)) +
  geom_pointrange(color = "grey",fatten=2) +
  
  # add baseline as a dashed red line WITH legend
  geom_vline(aes(xintercept = full_coef$estimate, 
                 linetype = "Baseline estimate", 
                 color = "Baseline estimate"),size=1.) +
  
  scale_color_manual(name = NULL, values = c("Baseline estimate" = "red")) +
  scale_linetype_manual(name = NULL, values = c("Baseline estimate" = "solid")) +
  
  labs(x = "NINO3.4 Log hazard ratio",
       y = "Removed famine episode") +
  theme_classic(base_size = 13) +
  theme(axis.text.y = element_blank(),
        legend.position = "bottom") + 
  
  #add vline at 0 fashed
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

ggsave("../figures/plots/loo_duration.pdf", device = cairo_pdf)

```






## Survival Curves




```{r, fig.width=6, fig.height=5}

year_of_interest <- 3

# --------------------------
# Prepare new data and survival fit
# --------------------------
new_data <- expand.grid(
  nino34 = c(-1, 0, 1, 2),  # La Niña, Neutral, El Niño
  Region = unique(famine_summary$Region)
)

surv_fit <- survfit(cox_base, newdata = new_data)
sf <- summary(surv_fit)

# Reshape to long format
sf_long <- tibble(
  time = sf$time,
  `La Niña (-1°)` = sf$surv[, 1],
  `Neutral` = sf$surv[, 2],
  `El Niño (+1°)` = sf$surv[, 3],
  `Strong El Niño (+2°)` = sf$surv[, 4]
) %>%
  pivot_longer(
    cols = -time,
    names_to = "ENSO",
    values_to = "surv"
  ) %>%
  mutate(event_prob = 1 - surv)

# --------------------------
# Compute delta for year 3
# --------------------------
sf_diff <- sf_long %>%
  filter(time == year_of_interest) %>%
  dplyr::select(ENSO, surv) %>%
  pivot_wider(names_from = ENSO, values_from = surv)

delta_val <- sf_diff$`Strong El Niño (+2°)` - sf_diff$`La Niña (-1°)`
delta_text <- paste0("Δ El Niño - La Niña = ", round(delta_val*100, 0), " p.p.")

# --------------------------
# Prepare points for arrows and labels
# --------------------------
sf_points <- sf_long %>%
  filter(time == year_of_interest, ENSO %in% c("Strong El Niño (+2°)", "La Niña (-1°)")) %>%
  mutate(prob_label = paste0(round(surv * 100, 1), "%"))

# --------------------------
# Plot survival curves
# --------------------------
x_offset <- 2
y_offset <- 0.05

# define colours and labels (order must match the ENSO factor values)
enso_levels <- c("Strong El Niño (+2°)", "La Niña (-1°)", "Neutral", "El Niño (+1°)")
enso_colors <- c("firebrick", "cornflowerblue", "black", "darksalmon")
names(enso_colors) <- enso_levels

# HTML/markdown labels coloured to match curves
enso_labels_html <- setNames(
  paste0("<span style='color:", enso_colors, "'>", enso_levels, "</span>"),
  enso_levels
)

# shapes mapping
enso_shapes <- c("Strong El Niño (+2°)" = 18,
                 "La Niña (-1°)" = 19,
                 "Neutral" = 16,
                 "El Niño (+1°)" = 17)

# your plotting code, updated
ggplot(sf_long, aes(x = time, y = surv, color = ENSO, shape = ENSO)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 3) +
  # arrows and percentage labels (keep show.legend = FALSE so they don't create extra legend entries)
  geom_segment(data = sf_points,
               aes(x = year_of_interest + x_offset, xend = year_of_interest,
                   y = surv + y_offset, yend = surv),
               arrow = arrow(length = unit(0.3, "cm")),
               inherit.aes = TRUE,
               linewidth = 1,
               show.legend = FALSE) +
  geom_text(data = sf_points,
            aes(x = year_of_interest + x_offset + 0.2, y = surv + y_offset,
                label = prob_label, color = ENSO),
            inherit.aes = FALSE,
            size = 5.5,
            hjust = 0,
            show.legend = FALSE) +

  # use the HTML/markdown labels for both color and shape scales so the legend merges
  scale_color_manual(values = enso_colors, labels = enso_labels_html) +
  scale_shape_manual(values = enso_shapes, labels = enso_labels_html) +

  labs(
    x = "Famine duration (years)",
    y = "Famine survival probability",
    color = NULL,
    shape = NULL
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_continuous(breaks = 1:12) +
  theme_classic(base_size = 14) +
  theme(
    text = element_text(color = "black", size = 14),
    legend.position = "top",
    legend.title = element_blank(),
    legend.text = element_markdown(size = 14),   # <- ggtext: lets our span-coloured labels render
    axis.text.x = element_text(color = "black", size = 14),
    axis.text.y = element_text(color = "black", size = 14),
    axis.title.x = element_text(color = "black", size = 14),
    axis.title.y = element_text(color = "black", size = 14),
    axis.ticks.length = unit(0.25, "cm"),
    axis.line = element_line(size = 0.6, color = "black"),
    panel.border = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  geom_vline(xintercept = year_of_interest, linetype = "dashed", color = "black", linewidth = 1) +
  annotate("label",
           x = year_of_interest + 6,
           y = (sf_diff$`Strong El Niño (+2°)` + sf_diff$`La Niña (-1°)`)-0.25,
           label = delta_text,
           size = 5.5,
           fill = "white",
           color = "black",
           label.size = 0.5) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE, override.aes = list(size = 3)),
    shape = guide_legend(nrow = 2, byrow = TRUE)
  )


# --------------------------
# Save figure
# --------------------------
ggsave("../figures/plots/survival_curves_dynamic.pdf", device = cairo_pdf)


```





```{r, fig.width=8, fig.height=7}
# Create new data for all combinations of ENSO states and Regions
new_data <- expand.grid(
  nino34 = c(-1, 0,1),  # La Niña, Neutral, El Niño
  Region = unique(famine_summary$Region)
)

# Predict survival curves
surv_fit <- survfit(cox_strata, newdata = new_data)

# Extract the summary
sf <- summary(surv_fit)

# Get the number of rows per curve from the summary
curve_lengths <- as.numeric(table(sf$strata))

# Repeat each row of new_data according to the number of time points in each curve
repeated_new_data <- new_data[rep(1:nrow(new_data), times = curve_lengths), ]

# Construct full dataframe
surv_df <- data.frame(
  time = sf$time,
  surv = sf$surv,
  lower = sf$lower,
  upper = sf$upper
) %>%
  bind_cols(repeated_new_data) %>%
  mutate(
    ENSO = factor(case_when(
      nino34 == -1 ~ "La Niña",
      nino34 == 0 ~ "Neutral",
      nino34 == 1 ~ "El Niño"
    ), levels = c("La Niña", "Neutral", "El Niño")),
    event_prob = 1 - surv
  )

# Plot
ggplot(surv_df, aes(x = time, y = surv, color = ENSO, shape = ENSO)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = c("La Niña" = "cornflowerblue", "Neutral" = "black", "El Niño" = "coral")) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = "Famine duration (years)",
    y = "Cumulative prob. of continuing famine ",
    color = "ENSO anomaly",
    shape = "ENSO anomaly"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  facet_wrap(~ Region, scales = "free", ncol = 3) +
  theme_classic(base_size=16) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    axis.title = element_text(size = 13, face = "bold"),
    axis.text = element_text(size = 11),
    strip.text = element_text(size = 12, face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90", size = 0.3)
  ) +
  scale_x_continuous(breaks = 1:12)

ggsave("../figures/plots/survival_curves_dynamic_strata.pdf", device = cairo_pdf)
```


```{r, fig.width=8, fig.height=7}
# Create new data for all combinations of ENSO states and Regions
new_data <- expand.grid(
  nino34 = c(-1, 0,1),  # La Niña, Neutral, El Niño
  Region = unique(famine_summary$Region)
)

# Predict survival curves
surv_fit <- survfit(cox_inter, newdata = new_data)

# Extract the summary
sf <- summary(surv_fit)

# Get the number of rows per curve from the summary
curve_lengths <- as.numeric(table(sf$strata))

# Repeat each row of new_data according to the number of time points in each curve
repeated_new_data <- new_data[rep(1:nrow(new_data), times = curve_lengths), ]

# Construct full dataframe
surv_df <- data.frame(
  time = sf$time,
  surv = sf$surv,
  lower = sf$lower,
  upper = sf$upper
) %>%
  bind_cols(repeated_new_data) %>%
  mutate(
    ENSO = factor(case_when(
      nino34 == -1 ~ "La Niña",
      nino34 == 0 ~ "Neutral",
      nino34 == 1 ~ "El Niño"
    ), levels = c("La Niña", "Neutral", "El Niño")),
    event_prob = 1 - surv
  )

# Plot
ggplot(surv_df, aes(x = time, y = surv, color = ENSO, shape = ENSO)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = c("La Niña" = "cornflowerblue", "Neutral" = "black", "El Niño" = "coral")) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = "Famine duration (years)",
    y = "Cumulative prob. of continuing famine ",
    color = "ENSO anomaly",
    shape = "ENSO anomaly"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  facet_wrap(~ Region, scales = "free", ncol = 3) +
  theme_classic(base_size=16) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    axis.title = element_text(size = 13, face = "bold"),
    axis.text = element_text(size = 11),
    strip.text = element_text(size = 12, face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90", size = 0.3)
  ) +
  scale_x_continuous(breaks = 1:12)

ggsave("../figures/plots/survival_curves_dynamic_inter.pdf", device = cairo_pdf)
```


```{r, fig.width=8, fig.height=7}
# Create new data for all combinations of ENSO states and Regions
new_data <- expand.grid(
  nino34 = c(-1, 0,1),  # La Niña, Neutral, El Niño
  Region = unique(famine_summary$Region)
)

# Predict survival curves
surv_fit <- survfit(cox_inter_strata, newdata = new_data)

# Extract the summary
sf <- summary(surv_fit)

# Get the number of rows per curve from the summary
curve_lengths <- as.numeric(table(sf$strata))

# Repeat each row of new_data according to the number of time points in each curve
repeated_new_data <- new_data[rep(1:nrow(new_data), times = curve_lengths), ]

# Construct full dataframe
surv_df <- data.frame(
  time = sf$time,
  surv = sf$surv,
  lower = sf$lower,
  upper = sf$upper
) %>%
  bind_cols(repeated_new_data) %>%
  mutate(
    ENSO = factor(case_when(
      nino34 == -1 ~ "La Niña",
      nino34 == 0 ~ "Neutral",
      nino34 == 1 ~ "El Niño"
    ), levels = c("La Niña", "Neutral", "El Niño")),
    event_prob = 1 - surv
  )

# Plot
ggplot(surv_df, aes(x = time, y = surv, color = ENSO, shape = ENSO)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = c("La Niña" = "cornflowerblue", "Neutral" = "black", "El Niño" = "coral")) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = "Famine duration (years)",
    y = "Cumulative prob. of continuing famine ",
    color = "ENSO anomaly",
    shape = "ENSO anomaly"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  facet_wrap(~ Region, scales = "free", ncol = 3) +
  theme_classic(base_size=16) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    axis.title = element_text(size = 13, face = "bold"),
    axis.text = element_text(size = 11),
    strip.text = element_text(size = 12, face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90", size = 0.3)
  ) +
  scale_x_continuous(breaks = 1:12)

ggsave("../figures/plots/survival_curves_dynamic_strata_interaction.pdf", device = cairo_pdf)
```





## Permutation check

```{r}
set.seed(42)
n_iter <- 10000

# Shuffle function — only reshuffling nino34
shuffle_data <- function(data, method) {
  if (method == "Entire Sample") {
    data %>% mutate(nino34 = sample(nino34))
    
  } else if (method == "Within Region") {
    data %>%
      group_by(start) %>%
      mutate(nino34 = if (n() > 1) sample(nino34) else nino34) %>%
      ungroup()
    
  } else {
    stop("Invalid shuffle method")
  }
}

# Set formula
formula <- Surv(start, stop, event) ~ nino34 + strata(Region)

# True model
true_model <- coxph(formula, data = famine_long)
true_coef_df <- as.data.frame(t(coef(true_model))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "True_Estimate")

# Shuffle methods
shuffle_methods <- c("Entire Sample")

# Store results
coef_list <- vector("list", n_iter * length(shuffle_methods))
index <- 1

# Loop
for (method in shuffle_methods) {
  for (i in 1:n_iter) {
    df_shuffled <- shuffle_data(famine_long, method)
    
    # Fit Cox model
    model_shuffled <- try(coxph(formula, data = df_shuffled), silent = TRUE)
    
    if (!inherits(model_shuffled, "try-error")) {
      coef_list[[index]] <- as.data.frame(t(coef(model_shuffled))) %>%
        mutate(iteration = i, shuffle_type = method)
    } else {
      coef_list[[index]] <- data.frame(nino34 = NA, iteration = i, shuffle_type = method)
    }
    
    index <- index + 1
  }
}

# Combine results
coef_df <- bind_rows(coef_list) %>%
  pivot_longer(cols = -c(iteration, shuffle_type), names_to = "Variable", values_to = "Estimate") %>%
  filter(!is.na(Estimate))

# Merge with true estimates
coef_df <- coef_df %>% left_join(true_coef_df, by = "Variable")

# Compute p-values
prob_df <- coef_df %>%
  group_by(Variable, shuffle_type) %>%
  summarise(
    prob_below = mean(Estimate <= True_Estimate),
    prob_above = mean(Estimate >= True_Estimate),
    True_Estimate = first(True_Estimate),
    .groups = "drop"
  ) %>%
  mutate(
    p_value = ifelse(True_Estimate < 0, prob_below, prob_above),
    prob_label = sprintf("p = %.3f", p_value)
  )

```


```{r,fig.width=5, fig.height=5}
ggplot(coef_df, aes(x = Estimate)) +
  geom_histogram(bins = 50, fill = "cornflowerblue", color = "white", alpha = 0.7) +
  geom_vline(aes(xintercept = True_Estimate), data = true_coef_df, color = "orange", linetype = "solid", size = 1) + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +  # Zero line for reference
  #facet_grid( factor(shuffle_type) ~ Variable, scales = "free") +  # Double facet by Variable and tau
  geom_text(data = prob_df, aes(x = 0.25, y = 200, label = prob_label), 
            color = "black", hjust = -0.1, size = 5) + 
  labs(
    x = "Coefficient Estimate",
    y = "Count"
  ) +
  theme_classic(base_size = 16)

ggsave("../figures/plots/permutation_test_dynamic.pdf", device = cairo_pdf)
```



# 2. Survival static model

## Regression Tables



```{r}
cox_base <- coxph(Surv(duration) ~ avg_nino34, data = famine_summary)


cox_strata <- coxph(Surv(duration)  ~ avg_nino34 + strata(Region), 
                   data = famine_summary)


cox_controls <- coxph(Surv(duration) ~ avg_nino34 + avg_ongoing_wars  + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter, data = famine_summary)



cox_controls_strata <- coxph(Surv(duration) ~ avg_nino34 + avg_ongoing_wars + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter + strata(Region), data = famine_summary)

# Interaction/RE

cox_inter <- coxph(Surv(duration) ~ avg_nino34:strata(Region) + Region, 
                   data = famine_summary)


cox_inter_controls <- coxph(Surv(duration) ~ avg_nino34:strata(Region) + avg_ongoing_wars + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter, 
                   data = famine_summary)

# RE

cox_frail <- coxph(Surv(duration) ~ avg_nino34 + frailty(Region), 
                   data = famine_summary)

cox_frail_strata <- coxph(Surv(duration) ~ avg_nino34 + frailty(Region) + strata(Region), 
                   data = famine_summary)

cox_ME <- coxme(Surv(duration) ~ avg_nino34 + avg_ongoing_wars+ (1+avg_nino34|Region), 
                   data = famine_summary)



```


```{r}
# --- Models list ---
models <- list(
  "(1)" = cox_base,
  "(2)" = cox_strata,
  "(3)" = cox_controls,
  "(4)" = cox_controls_strata,
  "(5)" = cox_frail,
  "(6)" = cox_frail_strata
)

# Cluster variable
cluster_var <- famine_long$famine_id

# Robust SEs
robust_vcovs <- lapply(models, function(model) {
  if (!inherits(model, "coxph")) return(NULL)
  has_cluster <- any(grepl("cluster", deparse(model$call)))
  if (has_cluster) {
    tryCatch(sandwich::vcovCL(model, cluster = cluster_var), error = function(e) NULL)
  } else {
    NULL
  }
})

# Extract AIC, BIC, Concordance, PH test
extract_info <- function(model) {
  if (!inherits(model, "coxph")) return(list(AIC = NA, BIC = NA, Concordance = NA, PH_p = NA))
  
  aic <- AIC(model)
  bic <- BIC(model)
  
  # Concordance
  c_index <- tryCatch({
    summary(model)$concordance[1]
  }, error = function(e) NA)

  # PH test p-value for nino34
  ph_p <- NA
  if (!any(grepl("frailty", deparse(model$call)))) {
    test <- try(cox.zph(model), silent = TRUE)
    if (!inherits(test, "try-error") && "nino34" %in% rownames(test$table)) {
      ph_p <- round(test$table["avg_nino34", "p"], 3)
    }
  }

  list(AIC = round(aic, 1), BIC = round(bic, 1), Concordance = round(c_index, 3), PH_p = ph_p)
}
info_list <- lapply(models, extract_info)
aic_values <- sapply(info_list, `[[`, "AIC")
bic_values <- sapply(info_list, `[[`, "BIC")
cindex_values <- sapply(info_list, `[[`, "Concordance")
ph_tests <- sapply(info_list, function(x) ifelse(is.na(x$PH_p), "-", sprintf("%.3f", x$PH_p)))

# Automatically detect model features
detect_in_call <- function(models, pattern) {
  sapply(models, function(model) {
    if (!inherits(model, "coxph")) return("-")
    ifelse(any(grepl(pattern, deparse(model$call))), "Yes", "No")
  })
}

region_FE <- detect_in_call(models, "strata\\(.*Region.*\\)|Region")
clustered_SEs <- detect_in_call(models, "cluster")
strata_region <- detect_in_call(models, "strata\\(.*Region.*\\)")
controls_included <- detect_in_call(models, "wars|pop")
frailty_included <- detect_in_call(models, "frailty")

# Build extra rows table
extra_rows <- tibble::tibble(
  term = c(
    "Clustered SEs",
    "Strata by Region",
    "Controls",
    "Random Effects",
    "Proportional Hazards p",
    "Concordance Index",
    "AIC",
    "BIC"
  ),
  !!!setNames(
    purrr::transpose(list(
      clustered_SEs,
      strata_region,
      controls_included,
      frailty_included,
      ph_tests,
      sprintf("%.3f", cindex_values),
      sprintf("%.1f", aic_values),
      sprintf("%.1f", bic_values)
    )),
    names(models)
  )
)

# Generate summary table
modelsummary(
    title = '\\label{tab:staticsurvENSO}Log Hazard Ratio of Nino 3.4 on Famine Duration, Static Cox Model',
  escape = FALSE,
  models,
  coef_omit = "^(?!.*avg_nino34).*",
  coef_map = c("avg_nino34" = "nino34"),
  vcov = robust_vcovs,
  gof_omit = ".*",
  add_rows = extra_rows,
  stars = c(`*` = 0.1, `**` = 0.05, `***` = 0.01),
  output = "../figures/tables/static_survival_models_reg.tex"
)
```


## Coef plots

```{r}
models <- list(
  "Base"                   = cox_base,
  "Region Strata"                 = cox_strata,
  "Controls"               = cox_controls,
  "Controls + Region Strata "    = cox_controls_strata
)

extract_nino34 <- function(model) {
  if (!inherits(model, "coxph")) return(NULL)
  
  # Extract the coefficients and check if robust SEs are available
  coefs <- summary(model)$coefficients
  nino34_coef <- coefs["avg_nino34", "coef"]
  
  nino34_se <- coefs["avg_nino34", "se(coef)"]
  
  
  return(c(coef = nino34_coef, se = nino34_se))
}

# Apply the function to all models and create a data frame
nino34_results <- lapply(models, extract_nino34)
nino34_df <- do.call(rbind, nino34_results)
nino34_df <- as.data.frame(nino34_df)
nino34_df$Model <- rownames(nino34_df)

# Calculate lower and upper bounds for the confidence interval
nino34_df$lower <- nino34_df$coef - 1.96 * nino34_df$se
nino34_df$upper <- nino34_df$coef + 1.96 * nino34_df$se

# Plot the results with refined styling
ggplot(nino34_df, aes(x = Model, y = coef, ymin = lower, ymax = upper)) +
  geom_pointrange(color = "royalblue", size = 1.5, fill = "white", 
                  fatten = 2, position = position_dodge(width = 0.6)) +  # Adds color and adjusts error bars
  theme_classic(base_size = 16) +  # Clean background and adjust base font size
  labs(
    y = "Coefficient Estimate for nino34", 
    x = "Model"
  ) +
  theme(
    axis.title = element_text(size = 14, face = "bold"),  # Make axis titles bold
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Center and bold the title
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.grid.major = element_line(color = "gray90", size = 0.5),  # Lighter grid lines for major grid
    axis.line = element_line(color = "black", size = 0.5),  # Add axis lines for structure
    legend.position = "none",  # Remove legend (if any)
    plot.margin = unit(c(1, 1, 1, 1), "cm")  # Increase plot margins for clarity
  ) +
  coord_flip()+ 
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  ylim(-1.8, 0)   # Set x-axis limits

ggsave("../figures/plots/nino34_survival_coef_static.pdf", device = cairo_pdf)
```



```{r}
extract_region_nino34 <- function(model, model_name) {
  if (!inherits(model, "coxph")) return(NULL)

  s <- summary(model)
  coefs <- s$coefficients

  # Get names that contain the interaction term
  term_rows <- grep("nino34.*Region", rownames(coefs), value = TRUE)
  if (length(term_rows) == 0) return(NULL)

  # Filter out NAs
  coefs <- coefs[term_rows, , drop = FALSE]
  coefs <- coefs[!is.na(coefs[, "coef"]), , drop = FALSE]

  # Extract standard errors: use "robust se" if available
  se_col <- if ("robust se" %in% colnames(coefs)) "robust se" else "se(coef)"

  # Clean region names
  regions <- gsub(".*Region\\)?", "", rownames(coefs))

  data.frame(
    model = model_name,
    Region = regions,
    coef = coefs[, "coef"],
    se = coefs[, se_col],
    stringsAsFactors = FALSE
  )
}

models <- list(
  "Base"                        = static_base,
  "Interaction"                 = static_inter,
  "Interaction + Cluster"       = static_inter_cluster,
  "Interaction + Cluster + Controls" = static_inter_controls
)

region_coefs <- lapply(names(models), function(name) {
  extract_region_nino34(models[[name]], name)
}) %>% bind_rows()

# Add confidence intervals
region_coefs <- region_coefs %>%
  mutate(
    lower = coef - 1.96 * se,
    upper = coef + 1.96 * se
  )

# Plot

ggplot(region_coefs, aes(x = Region, y = coef, ymin = lower, ymax = upper, color = model, group = model,shape=model)) +
  geom_point(position = position_dodge(width = 0.6), size = 2) +
  geom_errorbar(position = position_dodge(width = 0.6), width = 0.2, size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  theme_classic(base_size = 16) +
  labs(
    x = NULL,
    y = "Coefficient (log hazard ratio)",
    color = "Model",
    shape = "Model"
  ) +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0),
    plot.subtitle = element_text(size = 13, hjust = 0),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    legend.position = "top",
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
```




## Survival curves

```{r, fig.width=6, fig.height=5}
new_data <- expand.grid(
  avg_nino34 = c(-1, 0,1),  # La Niña, Neutral, El Niño
  Region = unique(famine_summary$Region)
)

cox_base <- coxph(Surv(duration) ~ avg_nino34 + Region, data = famine_summary)

# Get survfit
surv_fit <- survfit(cox_base, newdata = new_data)

# Extract and reshape summary
sf <- summary(surv_fit)

# Reshape survival values to long format manually
sf_long <- tibble(
  time = sf$time,
  `La Niña` = sf$surv[, 1],
  `Neutral` = sf$surv[, 2],
  `El Niño` = sf$surv[, 3]
) %>%
  pivot_longer(
    cols = -time,
    names_to = "ENSO",
    values_to = "surv"
  ) %>%
  mutate(event_prob = 1 - surv)

# Plot
ggplot(sf_long, aes(x = time, y = surv, color = ENSO, shape = ENSO)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 3) +
  #add confidence intervals
  scale_color_manual(values = c("La Niña" = "cornflowerblue", "Neutral" = "black", "El Niño" = "coral")) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = "Famine duration (years)",
    y = "Cumulative prob. of continuing famine ",
    color = "ENSO anomaly",
    shape = "ENSO anomaly"
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_classic(base_size=16) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 15, face = "bold"),
    legend.text = element_text(size = 15),
    axis.title = element_text(size = 15, face = "bold"),
    axis.text = element_text(size = 15),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90", size = 0.3)
  ) +
  scale_x_continuous(breaks = 1:12)

ggsave("../figures/plots/survival_curves_static.pdf", device = cairo_pdf, dpi=300)
```



```{r, fig.width=8, fig.height=7}
# Fit Cox model with strata on Region
cox_model <- coxph(Surv(duration) ~ avg_nino34:strata(Region),
                   data = famine_summary)

# Create new data for all combinations of ENSO states and Regions
new_data <- expand.grid(
  avg_nino34 = c(-1, 0,1),  # La Niña, Neutral, El Niñ
  Region = unique(famine_summary$Region)
)

# Predict survival curves
surv_fit <- survfit(cox_model, newdata = new_data)

# Extract the summary
sf <- summary(surv_fit)

# Get the number of rows per curve from the summary
curve_lengths <- as.numeric(table(sf$strata))

# Repeat each row of new_data according to the number of time points in each curve
repeated_new_data <- new_data[rep(1:nrow(new_data), times = curve_lengths), ]

# Construct full dataframe
surv_df <- data.frame(
  time = sf$time,
  surv = sf$surv,
  lower = sf$lower,
  upper = sf$upper
) %>%
  bind_cols(repeated_new_data) %>%
  mutate(
    ENSO = factor(case_when(
      avg_nino34 == -1 ~ "La Niña",
      avg_nino34 == 0 ~ "Neutral",
      avg_nino34 == 1 ~ "El Niño"
    ), levels = c("La Niña", "Neutral", "El Niño")),
    event_prob = 1 - surv
  )

# Plot
ggplot(surv_df, aes(x = time, y = surv, color = ENSO, shape = ENSO)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(values = c("La Niña" = "cornflowerblue", "Neutral" = "black", "El Niño" = "coral")) +
  scale_shape_manual(values = c(16, 17, 18)) +
  labs(
    x = "Famine duration (years)",
    y = "Cumulative probability famine has ended",
    color = "ENSO anomaly",
    shape = "ENSO anomaly"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  facet_wrap(~ Region, scales = "free", ncol = 3) +
  theme_classic(base_size=16) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    axis.title = element_text(size = 13, face = "bold"),
    axis.text = element_text(size = 11),
    strip.text = element_text(size = 12, face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90", size = 0.3)
  )

ggsave("../figures/plots/survival_curves_static_strata.pdf", device = cairo_pdf, dpi=300)
```



# 3. parametric models

```{r}
exp <- survreg(Surv(duration) ~avg_nino34  , data= famine_summary, dist="exponential")
weib <- survreg(Surv(duration) ~ avg_nino34 + strata(Region), data= famine_summary, dist="weibull")
loglog <- survreg(Surv(duration) ~ avg_nino34 + strata(Region), data= famine_summary, dist="loglogistic")
gauss <- survreg(Surv(duration) ~ avg_nino34 + strata(Region), data= famine_summary, dist="gaussian")

stargazer(weib, loglog, gauss,
          type = "text",
          title = "Survival Models",
          dep.var.labels = c("Duration"),
          covariate.labels = c("Nino34"),
          single.row = TRUE,
          star.char = c("*", "**", "***"),
          star.cutoffs = c(0.1, 0.05, 0.01))

stargazer(weib, loglog, gauss,
          type = "latex",
          title = "Parametric Survival Models of Famine Duration",
          dep.var.labels = c("Duration"),
          covariate.labels = c("Nino34"),
          single.row = TRUE,
          star.char = c("*", "**", "***"),
          star.cutoffs = c(0.1, 0.05, 0.01), 
          out = "../figures/tables/survival_models_parametric.tex")

```



#4. FE on duration

```{r}


ols_1 <- feols(duration ~ avg_nino34|Region, data = famine_summary,
      cluster = ~Region)

ols_controls <- feols(duration ~  avg_nino34 + avg_ongoing_wars  + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter|Region, data = famine_summary,
      cluster = ~Region)

pois_1 <- fepois(duration ~ avg_nino34|Region, data = famine_summary,
      cluster = ~Region)

pois_controls <- fepois(duration ~  avg_nino34 + avg_ongoing_wars  + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter|Region, data = famine_summary,
      cluster = ~Region)

negbin_1 <- fenegbin(duration ~ avg_nino34|Region, data = famine_summary,
      cluster = ~Region)

negbin_controls <- fenegbin(duration ~  avg_nino34 + avg_ongoing_wars  + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter|Region, data = famine_summary,
      cluster = ~Region)




dict = c(avg_nino34 = "Nino3.4",
         max_2y_nino = "Max Nino3.4 (2y)",
         avg_ongoing_wars = "Ongoing wars",
         `log(avg_population)` = "log(Population)",
         avg_Price_detrended = "Price (detrended)",
         duration = "Duration (years)") 



etable(ols_1, ols_controls, pois_1, pois_controls, negbin_1, negbin_controls,
          keep = "Nino",
fitstat = c("AIC","BIC", "N", "cor2"),
label = "tab:duration_avgnino",
title = "Effect of a 1°C Anomaly in the Average Nino 3.4 Index During a Famine on Its Duration",
      extralines = list(
                  "Controls" = c("No", "Yes", "No", "Yes", "No", "Yes")),
       file = "../figures/tables/famine_duration_fe_avgnino.tex",
       dict = dict,
       replace=TRUE)
etable(ols_1, ols_controls, pois_1, pois_controls, negbin_1, negbin_controls)

```


```{r}
ols_1 <- feols(duration ~ max_2y_nino|Region, data = famine_summary,
      cluster = ~Region)

ols_controls <- feols(duration ~ max_2y_nino + avg_ongoing_wars  + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter|Region, data = famine_summary,
      cluster = ~Region)

pois_1 <- fepois(duration ~ max_2y_nino|Region, data = famine_summary,
      cluster = ~Region)

pois_controls <- fepois(duration ~ max_2y_nino + avg_ongoing_wars  + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter|Region, data = famine_summary,
      cluster = ~Region)

negbin_1 <- fenegbin(duration ~ max_2y_nino|Region, data = famine_summary,
      cluster = ~Region)

negbin_controls <- fenegbin(duration ~ max_2y_nino + avg_ongoing_wars  + avg_temp_summer + avg_temp_winter + avg_PDSI + avg_precip_winter|Region, data = famine_summary,
      cluster = ~Region)




dict = c(avg_nino34 = "Nino34",
         max_2y_nino = "Max Nino34 (2y)",
         avg_ongoing_wars = "Ongoing wars",
         `log(avg_population)` = "log(Population)",
         avg_Price_detrended = "Price (detrended)",
         duration = "Duration (years)") 



etable(ols_1, ols_controls, pois_1, pois_controls, negbin_1, negbin_controls,
          dict = dict,
          keep = "Nino",
fitstat = c("AIC","BIC", "N", "cor2"),
title = "Effect of a 1°C Anomaly in the Maximum Nino 3.4 Index During the Initial Two Years of Famine on Its Duration",
      label = "tab:duration_maxnino",
      extralines = list(
                  "Controls" = c("No", "Yes", "No", "Yes", "No", "Yes")),
       file = "../figures/tables/famine_duration_fe_maxnino.tex",
       replace=TRUE)

etable(ols_1, ols_controls, pois_1, pois_controls, negbin_1, negbin_controls)
```





# 5. Famine starts


```{r, fig.width=5, fig.height=5}
# Identify famine onset years for Central Europe
central_data <- data %>%
  filter(Region == "Central Europe") %>%
  arrange(Region, Year) %>%
  mutate(Famine_onset = Famine_start == 1)

# Prepare dataset for plotting
plot_df <- bind_rows(
  central_data %>%
    filter(Famine_onset) %>%
    transmute(NINO3.4 = nino34, Group = "Famine Onset"),
  central_data %>%
    filter(Famine == 0) %>%
    transmute(NINO3.4 = nino34, Group = "No Famine")
)

# ---- Plot ----
ggplot(plot_df, aes(x = Group, y = NINO3.4, fill = Group)) +
  geom_boxplot(width = 0.5, linewidth = 1.1, outlier.shape = NA) +
  geom_jitter(color = "black", alpha = 0.6, width = 0.15) +
  scale_fill_manual(values = c("Famine Onset" = "darksalmon", "No Famine" = "lightblue")) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 1) +
  theme_classic(base_size = 14) +
  theme(
    legend.position = "none",                         # remove legend
    text = element_text(color = "black", size = 14),
    axis.text.x = element_text(angle = 0, hjust = 0.5, color = "black", size = 14),  # tick labels only
    axis.text.y = element_text(color = "black", size = 14),
    axis.title.x = element_blank(),                  # remove x-axis title
    axis.title.y = element_text(color = "black", size = 14),
    axis.ticks.length = unit(0.25, "cm"),
    axis.line = element_line(size = 0.6, color = "black"),
    panel.border = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  ylab("NINO3.4")

# Save the figure
ggsave("../figures/plots/nino34_central_box.pdf", width = 4, height = 4, dpi = 300)
```


```{r}

est0 <- feols(Famine_start ~ nino34:Region,
              data = data, vcov = NW~Year, panel.id = c("Region", "Year"))

est1 <- feols(Famine_start ~ nino34:Region + i(Decade),
              data = data, vcov = NW~Year, panel.id = c("Region", "Year"))

est2 <- feols(Famine_start ~   nino34:Region + i(Decade)|Region,
              data = data, vcov = DK~Year, panel.id = c("Region", "Year"))

est3 <- feols(Famine_start ~  nino34:Region + i(Decade) + PDSI:Region + temp_summer:Region + temp_winter:Region + precip_summer:Region + precip_winter:Region + ongoing_wars:Region + log(1+Deaths):Region|Region,
              data = data, vcov = DK~Year, panel.id = c("Region", "Year"))


est4 <- feglm(Famine_start ~   nino34:Region + i(Decade):Region + PDSI:Region + temp_summer:Region + temp_winter:Region + precip_summer:Region + precip_winter:Region + ongoing_wars:Region + log(1+Deaths):Region |Region, vcov = "iid",
              data = data, panel.id = c("Region", "Year"), family = "logit")


est5 <- feols(Famine_start ~  nino34 + i(Decade) + PDSI + temp_summer + temp_winter + precip_summer + precip_winter + ongoing_wars + log(1+Deaths)|Region,
              data = data, vcov = DK~Year, panel.id = c("Region", "Year"))

est6 <- feglm(Famine_start ~ nino34 + i(Decade) + PDSI + temp_summer + temp_winter + precip_summer + precip_winter + ongoing_wars + log(1+Deaths)|Region,
              data = data, vcov = "iid", panel.id = c("Region", "Year"), family = "logit")




dict = c(nino34 = "Nino3.4",
         Famine_start = "Famine Start")



etable(est0, est1,est2,est3,est4,est5,est6,
          keep = c("Nino3.4","(Intercept)"),
              drop.section = "fixef",
fitstat = c("AIC","BIC", "N", "cor2"),
      extralines = list(
        "Decade FE" = c("No", "Yes", "Yes", "Yes", "Yes", "Yes", "Yes"),
        "Region FE" = c("No", "No","Yes", "Yes", "Yes", "Yes", "Yes"),
                  "Controls" = c("No","No", "No", "Yes", "Yes", "Yes", "Yes"),
        "Standard Errors" = c("Newey-West","Newey-West", "Driscoll-Kray", "Driscoll-Kray", "IID", "IID", "Driscoll-Kray")),
                  
       file = "../figures/tables/famine_starts_reg.tex",
       label = "tab:famine_starts",
title = "Effect of a 1°C Anomaly in the Nino 3.4 Index on the Probability of a Famine Start",
       dict = dict,
       replace=TRUE)

etable(est0,est1,est2,est3,est4,est5,est6,
       dict=dict,
          keep = c("Nino3.4","Constant","nino34"))

```
```{r}
confint(est2)
```



```{r, fig.width=5, fig.height=4}
# Tidy the model outputs and filter to Nino3.4 coefficients
tidy_all <- bind_rows(
  broom::tidy(est0, conf.int = TRUE) %>% mutate(model = "No FEs"),
  broom::tidy(est2, conf.int = TRUE) %>% mutate(model = "FEs"),
  broom::tidy(est3, conf.int = TRUE) %>% mutate(model = "FEs + Controls")
) %>%
  filter(grepl("nino34", term)) %>%
  mutate(
    Region = gsub("nino34:Region", "", term),
    Region = trimws(Region)
  )

tidy_all$Region <- factor(tidy_all$Region, levels = unique(tidy_all$Region))

# Plot
ggplot(tidy_all, aes(x = Region, y = estimate, color = model)) +
  geom_pointrange(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = 0.6),
    size = 1,
    fatten = 3
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(values = c("No FEs" = "cornflowerblue", 
                                "FEs" = "orange", 
                                "FEs + Controls" = "firebrick")) +
  labs(
    y = "Famine Onset Probability",
    x = NULL,
    color = "Model"
  ) +
theme_classic(base_size = 13) +
  theme(
    text = element_text(color = "black", size = 13),   # all text black, size 12
    legend.position = "top",
    legend.text = element_text(color = "black", size = 13),
    legend.title = element_text(color = "black", size = 14),
    axis.text.x = element_text(angle = 25, hjust = 1, color = "black", size = 13),
    axis.text.y = element_text(color = "black", size = 13),
    axis.title.x = element_text(color = "black", size = 13),
    axis.title.y = element_text(color = "black", size = 13),
    axis.ticks.length = unit(0.25, "cm"),
    axis.line = element_line(size = 0.5, color = "black"),
    panel.border = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  )

ggsave("../figures/plots/famine_start_coef.pdf", device = cairo_pdf, dpi = 300)
```


## Accuracy of OLS

```{r}
est_central <- feols(Famine_start ~ nino34 + i(Decade) + PDSI + temp_summer + temp_winter + precip_summer + precip_winter + ongoing_wars|Region,
              data = data %>% filter(Region == "Central Europe"), vcov = DK~Year, panel.id = c("Region", "Year"))

accuracy <- function(model, data) {
  preds <- predict(model, newdata = data)
  preds_binary <- ifelse(preds > 0.5, 1, 0)
  mean(preds_binary == data$Famine_start)
}

accuracy(est_central, data %>% filter(Region == "Central Europe"))
```
## Attribution

```{r}

estcf <- feglm(Famine_start ~   nino34:Region + i(Decade):Region  |Region, vcov = "iid",
              data = data, panel.id = c("Region", "Year"), family = "logit")
#create counterfactual df where nino3.4 i 0 in famine starting years
data_cf <- data %>%
  mutate(nino34 = ifelse(Famine_start == 1, 0, nino34))

#predict famine starts with cf data
preds_cf <- predict(estcf, newdata = data_cf, type = "response")
preds_label = ifelse(preds_cf > 0.5, 1, 0)
data_cf <- data_cf %>%
  mutate(preds_cf = preds_cf,
         preds_label = preds_label)
```


## Permutation check

```{r}
set.seed(42)
n_iter <- 10000

# Shuffle function — only reshuffling nino34
shuffle_data <- function(data, method) {
  if (method == "Entire Sample") {
    data %>% mutate(nino34 = sample(nino34))
    
  } else if (method == "Within Region") {
    data %>%
      group_by(Region) %>%
      mutate(nino34 = if (n() > 1) sample(nino34) else nino34) %>%
      ungroup()
    
  } else {
    stop("Invalid shuffle method")
  }
}

# Set formula
formula <- Famine_start ~ nino34:Region + i(Decade)

# True model
true_model <- feols(formula, data = data,warn=FALSE,notes=FALSE)

# Keep only nino34:Central
true_coef_df <- as.data.frame(t(coef(true_model))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "True_Estimate") %>%
  filter(Variable == "nino34:RegionCentral Europe")

# Shuffle methods
shuffle_methods <- c("Entire Sample")

# Store results
coef_list <- vector("list", n_iter * length(shuffle_methods))
index <- 1

# Loop
for (method in shuffle_methods) {
  for (i in 1:n_iter) {
    df_shuffled <- shuffle_data(data, method)
    
    # Fit model
    model_shuffled <- try(feols(formula, data = df_shuffled, warn = FALSE,notes=FALSE), silent = TRUE)
    
    if (!inherits(model_shuffled, "try-error")) {
      coef_list[[index]] <- as.data.frame(t(coef(model_shuffled))) %>%
        pivot_longer(cols = everything(), names_to = "Variable", values_to = "Estimate") %>%
        filter(Variable == "nino34:RegionCentral Europe") %>%
        mutate(iteration = i, shuffle_type = method)
    } else {
      coef_list[[index]] <- data.frame(
        Variable = "nino34:RegionCentral Europe",
        Estimate = NA,
        iteration = i,
        shuffle_type = method
      )
    }
    
    index <- index + 1
  }
}

# Combine results
coef_df <- bind_rows(coef_list) %>%
  filter(!is.na(Estimate)) %>%
  left_join(true_coef_df, by = "Variable")

# Compute p-values
prob_df <- coef_df %>%
  group_by(Variable, shuffle_type) %>%
  summarise(
    prob_below = mean(Estimate <= True_Estimate),
    prob_above = mean(Estimate >= True_Estimate),
    True_Estimate = first(True_Estimate),
    .groups = "drop"
  ) %>%
  mutate(
    p_value = ifelse(True_Estimate < 0, prob_below, prob_above),
    prob_label = sprintf("p = %.3f", p_value)
  )


```


```{r, fig.height=5, fig.width=5}
ggplot(coef_df, aes(x = Estimate)) +
  geom_histogram(bins = 50, fill = "cornflowerblue", color = "white", alpha = 0.7) +
  geom_vline(aes(xintercept = True_Estimate), data = true_coef_df, color = "orange", linetype = "solid", size = 1) + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +  # Zero line for reference
  #facet_grid( factor(shuffle_type) ~ Variable, scales = "free") +  # Double facet by Variable and tau
  geom_text(data = prob_df, aes(x = -0.1, y = 200, label = prob_label), 
            color = "black", hjust = -0.1, size = 5) + 
  labs(
    x = "Coefficient Estimate",
    y = "Count"
  ) +
  theme_classic(base_size = 16)

ggsave("../figures/plots/permutation_lpm_onset.pdf", device = cairo_pdf)
```



## Loo

```{r}
# Baseline model
est_full <- feols(Famine_start ~ nino34:Region + i(Decade),
                  data = data, vcov = NW~Year, panel.id = c("Region", "Year"))

# Get baseline coefficients
full_coef <- broom::tidy(est_full)

famine_ids <- which(data$Famine_start == 1 & data$Region == "Central Europe")

# Loop over famine events
loo_results <- map_dfr(seq_along(famine_ids), function(i) {
  idx <- famine_ids[i]
  
  # Drop this famine onset
  data_loo <- data[-idx, ]
  
  # Re-estimate
  mod <- feols(Famine_start ~ nino34:Region + i(Decade):Region,
               data = data_loo, vcov = NW~Year, panel.id = c("Region", "Year"), notes=FALSE)
  
  broom::tidy(mod) %>%
    mutate(left_out = paste0("Famine_", i))
})

# Combine with baseline
loo_results <- loo_results %>%
  left_join(full_coef %>% dplyr::select(term, estimate) %>% 
              rename(full_estimate = estimate),
            by = "term")
```

```{r, fig, fig.width=6, fig.height=5}
# Filter to only Central region interaction
loo_central <- loo_results %>%
  filter(term == "nino34:RegionCentral Europe")

# Baseline estimate for Central
baseline_central <- unique(loo_central$full_estimate)

 ggplot(loo_central,
                    aes(y = reorder(left_out, estimate),
                        x = estimate,
                        xmin = estimate - 1.96 * std.error,
                        xmax = estimate + 1.96 * std.error)) +
  geom_pointrange(color = "grey40") +
  
  # Baseline reference line
  geom_vline(aes(xintercept = baseline_central,
                 linetype = "Baseline estimate",
                 color = "Baseline estimate"),
             size = 1.) +
  
  scale_color_manual(name = NULL,
                     values = c("Baseline estimate" = "red")) +
  scale_linetype_manual(name = NULL,
                        values = c("Baseline estimate" = "dashed")) +
  
  labs(x = "Coefficient on NINO3.4 × Central",
       y = "Removed famine onset") +
  theme_classic(base_size = 13) +
  theme(axis.text.y = element_blank(),
        legend.position = "bottom") +
   #add 0 line dashed vertical
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")
 
 ggsave("../figures/plots/loo_lpm_onset.pdf", device = cairo_pdf)
```




# 


```{r}
#CREATE A DUMMY FOR fAMINE START IN CENTRAL EUROPE
data_spill <- data %>%
  arrange(Region, Year) %>%
  group_by(Year) %>%
  mutate(
    # Check if Central Europe has a famine start in this year
    Famine_start_CE = ifelse(any(Region == "Central Europe" & Famine_start == 1), 1, 0),
  ) %>%
  ungroup() %>%
  # Optionally, set Central Europe famine_start to 0 to avoid double-counting
  mutate(Famine_start = ifelse(Region == "Central Europe", 0, Famine_start)) %>% 
  #remove central europe from the sample
  filter(Region != "Central Europe")

#run a model where we see whetehr famine in central europe triggered famine in other regions
est_spill <- feols(Famine_start ~ l(Famine_start_CE,0:3) + i(Decade) | Region,
                  data = data_spill, vcov = DK~Year, panel.id = c("Region", "Year"))

summary(est_spill)
```

